<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Transactions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
  <style>
    th {
      white-space: nowrap;
    }
    td.nowrap {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="mb-4">Transactions</h1>
    {% if filter_info %}
      <p class="text-muted"><small>{{ filter_info }}</small></p>
    {% endif %}
    <div class="mb-3">
      <button id="resetFilters" class="btn btn-secondary btn-sm">
        <i class="bi bi-arrow-clockwise me-1"></i>Reset Filters
      </button>
    </div>
    {% set headers = transactions[0].getDictionary().keys() | list if transactions|length > 0 else [] %}
    <table id="transactionsTable" class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            {% for header in headers %}
            <th>{% if header in icon_map %}<i class="{{ icon_map[header]|safe }}"></i>{% endif %} {{ header.replace('_', ' ') | title }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tfoot>
        <tr>
            {% for header in headers %}
            <th><input type="text" class="form-control form-control-sm" placeholder="Search {{ header | title }}"></th>
            {% endfor %}
        </tr>
    </tfoot>
    <tbody>
        {% for row in transactions %}
        <tr class="{% if row.value is none %}table-warning{% endif %}">
            {% for header in headers %}
            {% if header == "value" %}
                <td class="nowrap">
                {% if row[header] is not none %}
                    {% if row[header] < 0 %}
                    <i class="bi bi-arrow-down-circle-fill text-danger me-1"></i>
                    <span class="text-danger">{{ row[header] }}</span>
                    {% else %}
                    <i class="bi bi-arrow-up-circle-fill text-success me-1"></i>
                    <span class="text-success">{{ row[header] }}</span>
                    {% endif %}
                {% else %}
                    <span class="text-danger">No Value defined!</span>
                {% endif %}
                </td>
            {% else %}
                <td>{{ row[header] }}</td>
            {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
    </table>
  </div>
  <footer class="text-center mt-4">
    <small>
      This project is licensed under the <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a> &mdash; 
      developed by <a href="https://www.veen.world/" target="_blank">Kevin Veen-Birkenbach</a>. 
      View source on <a href="https://github.com/kevinveenbirkenbach/financial-helper" target="_blank">GitHub</a>.
    </small>
  </footer>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    $(document).ready(function() {
        $('#transactionsTable tfoot th').each(function () {
            var title = $(this).text();
            $(this).html('<input type="text" placeholder="Search ' + title + '" class="form-control form-control-sm" />');
        });
        
        var table = $('#transactionsTable').DataTable({
            "order": [[ 0, "desc" ]],
            "pageLength": 25,
            "lengthMenu": [[10, 25, 50, 100, 200, 500, 1000, 2000, 5000, -1], [10, 25, 50, 100, 200, 500, 1000, 2000, 5000, "All"]],
            initComplete: function () {
                this.api().columns().every(function () {
                    var column = this;
                    var uniqueData = column.data().unique().sort().toArray();
                    if(uniqueData.length <= 12) {
                        var select = $("<select class='form-select form-select-sm'><option value=''>All</option></select>")
                            .appendTo($(column.footer()).empty())
                            .on("change", function () {
                                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                column.search(val ? "^" + val + "$" : "", true, false).draw();
                            });
                        $.each(uniqueData, function (i, d) {
                            select.append("<option value='" + d + "'>" + d + "</option>");
                        });
                    } else {
                        $("input", column.footer()).on("keyup change clear", function () {
                            if (column.search() !== this.value) {
                                column.search(this.value).draw();
                            }
                        });
                    }
                });
            }
        });

        // Reset Filters button: clear all column searches and redraw table.
        $('#resetFilters').on('click', function () {
            table.columns().search('').draw();
            $('#transactionsTable tfoot input').val('');
            $('#transactionsTable tfoot select').val('');
        });
    });
  </script>
</body>
</html>